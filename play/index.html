<!DOCTYPE html>
<html lang="en">
<head>
    <title>three.js editor</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
</head>
<body>
<link href="css/types.css" rel="stylesheet"/>
<link id="theme" href="css/light.css" rel="stylesheet"/>

<link href="icons/styles.css" rel="stylesheet"/>
<link href="css/playful.css" rel="stylesheet"/>

<script src="build/three.js"></script>
<script src="js/libs/three/libs/system.min.js"></script>

<script src="js/libs/three/controls/EditorControls.js"></script>
<script src="js/libs/three/controls/TransformControls.js"></script>
<script src="js/libs/three/controls/PointerLockControls.js"></script>
<script src="js/libs/three/loaders/BabylonLoader.js"></script>
<script src="js/libs/three/loaders/ColladaLoader.js"></script>
<script src="js/libs/three/loaders/OBJLoader.js"></script>
<script src="js/libs/three/loaders/PLYLoader.js"></script>
<script src="js/libs/three/loaders/STLLoader.js"></script>
<script src="js/libs/three/loaders/UTF8Loader.js"></script>
<script src="js/libs/three/loaders/VRMLLoader.js"></script>
<script src="js/libs/three/loaders/VTKLoader.js"></script>
<script src="js/libs/three/loaders/ctm/lzma.js"></script>
<script src="js/libs/three/loaders/ctm/ctm.js"></script>
<script src="js/libs/three/loaders/ctm/CTMLoader.js"></script>
<script src="js/libs/three/exporters/SceneExporter.js"></script>
<script src="js/libs/three/exporters/OBJExporter.js"></script>
<script src="js/libs/three/exporters/STLExporter.js"></script>
<script src="js/libs/three/renderers/RaytracingRenderer.js"></script>
<script src="js/libs/three/renderers/SoftwareRenderer.js"></script>
<script src="js/libs/three/renderers/SVGRenderer.js"></script>
<script src="js/libs/three/renderers/WebGLDeferredRenderer.js"></script>
<script src="js/libs/three/ShaderDeferred.js"></script>

<!-- WIP -->

<script src="js/libs/three/BufferGeometryUtils.js"></script>

<script src="js/libs/three/exporters/BufferGeometryExporter.js"></script>
<script src="js/libs/three/exporters/Geometry2Exporter.js"></script>
<script src="js/libs/three/exporters/GeometryExporter.js"></script>
<script src="js/libs/three/exporters/MaterialExporter.js"></script>
<script src="js/libs/three/exporters/ObjectExporter.js"></script>
<script src="js/libs/three/renderers/WebGLRenderer3.js"></script>
<script src="js/libs/three/effects/StereoEffect.js"></script>

<script src="js/libs/signals.min.js"></script>
<script src="js/libs/physi.js"></script>
<script src="js/libs/ui.js"></script>
<script src="js/libs/ui.editor.js"></script>
<script src="js/libs/ui.three.js"></script>
<script src='js/libs/webaudiox.lineout.js'></script>
<script src='js/libs/webaudiox.loadbuffer.js'></script>
<script src='js/libs/webaudiox.three.js'></script>
<script src='js/libs/webaudiox.analyser2volume.js'></script>
<script src='js/libs/SoundCollection.js'></script>
<script src="js/libs/FileSaver.js"></script>
<script src="js/libs/jszip.min.js"></script>
<script src="js/libs/idb.filesystem.js"></script>
<script src='js/libs/Skybox.js'></script>
<script src="js/libs/leap-0.6.1.min.js"></script>
<script src="js/libs/leap-plugins-0.1.6.js"></script>
<script src="js/libs/leap.rigged-hand-0.1.4.min.js"></script>
<script src="js/libs/jquery-2.1.1.min.js"></script>
<script src="js/libs/PlayOrbitControls.js"></script>
<script src="js/libs/logger.min.js"></script>

<script src="js/Editor.js"></script>
<script src="js/Editor.Theme.js"></script>
<script src="js/Editor.TemplateManager.js"></script>
<script src="js/ObjectPropertyService.js"></script>
<script src="js/Template.js"></script>
<script src="js/Config.js"></script>

<script src="js/core/Loader.js"></script>
<script src="js/core/Storage.js"></script>
<script src="js/core/PlayfulExporter.js"></script>
<script src="js/core/ObjectLoader.js"></script>

<script src="https://www.google.com/recaptcha/api.js?render=explicit"></script>
<script src="js/menues/GalleryPanel.js"></script>
<script src="js/menues/GalleryCameraPanel.js"></script>
<script src="js/menues/GalleryUploadPanel.js"></script>

<script src="js/menues/sidebars/Sidebars.js"></script>
<script src="js/menues/sidebars/Sidebars.Add.js"></script>
<script src="js/menues/sidebars/Sidebars.AddTemplate.js"></script>
<script src="js/menues/sidebars/Sidebars.File.js"></script>
<script src="js/menues/sidebars/Sidebars.File.ExportSceneHelper.js"></script>
<script src="js/menues/sidebars/Sidebars.Help.js"></script>
<script src="js/menues/sidebars/Sidebars.View.js"></script>
<script src="js/menues/sidebars/Sidebars.Scene.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.js"></script>
<script src="js/menues/sidebars/Sidebars.Renderer.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Object3D.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Animation.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Scene.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.BoxGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.CircleGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.CylinderGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.IcosahedronGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.PlaneGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.SphereGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.TorusGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Geometry.TorusKnotGeometry.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Material.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Physics.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Events.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.AdvancedSwitch.js"></script>
<script src="js/menues/sidebars/Sidebars.Properties.Behaviors.js"></script>

<script src="js/menues/Tools.js"></script>
<script src="js/menues/Tools.Menu.js"></script>
<script src="js/menues/Tools.Modes.js"></script>
<script src="js/menues/Tools.View.js"></script>

<script src="js/Viewport.js"></script>
<script src="js/Play.js"></script>
<script src="js/Play.Effects.js"></script>

<!-- ---------------- Custom Glow Shader Code ------------------------ -->
<script id="glowVertexShader" type="x-shader/x-vertex">
		uniform vec3 viewVector;
		uniform float c;
		uniform float p;
		varying float intensity;
		void main()
		{
			vec3 vNormal = normalize( normalMatrix * normal );
			vec3 vNormel = normalize( normalMatrix * viewVector );
			intensity = pow( c - dot(vNormal, vNormel), p );

			gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );
		}

</script>

<!-- fragment shader a.k.a. pixel shader -->
<script id="glowFragmentShader" type="x-shader/x-vertex">
		uniform vec3 glowColor;
		varying float intensity;
		void main()
		{
			vec3 glow = glowColor * intensity;
			gl_FragColor = vec4( glow, 1.0 );
		}

</script>
<!-- ----------------------------------------------------------- -->

<!-- Three.js overrides -->
<script>

    // Log messages will be written to the window's console.
    Logger.useDefaults();
    // remove this to log all info
    Logger.setLevel(Logger.WARN);


    // We also want the objects to clone other stuff, like sounds

    THREE.Object3D.prototype.cloneBase = THREE.Object3D.prototype.clone;
    THREE.Object3D.prototype.clone = function (object, recursive) {

        object = THREE.Object3D.prototype.cloneBase.call(this, object, recursive);

        // clone sounds
        if (this.sounds != undefined) {

            object.sounds = {};

            for (var key in this.sounds) {
                if (this.sounds.hasOwnProperty(key)) {

                    object.sounds[key] = this.sounds[key];

                }
            }
        }

        return object;

    };

    THREE.Geometry.prototype.clone = function () {

        var geometry = new THREE.Geometry(), geomParams = this.parameters;

        var handleParameters = function (type, params) {
            geometry = new type(
                    params[0] ? geomParams[params[0]] : undefined,
                    params[1] ? geomParams[params[1]] : undefined,
                    params[2] ? geomParams[params[2]] : undefined,
                    params[3] ? geomParams[params[3]] : undefined,
                    params[4] ? geomParams[params[4]] : undefined,
                    params[5] ? geomParams[params[5]] : undefined,
                    params[6] ? geomParams[params[6]] : undefined,
                    params[7] ? geomParams[params[7]] : undefined,
                    params[8] ? geomParams[params[8]] : undefined,
                    params[9] ? geomParams[params[9]] : undefined
            );
            /*console.log( geometry, params[0] ? geomParams[ params[0] ] : undefined,
             params[1] ? geomParams[ params[1] ] : undefined,
             params[2] ? geomParams[ params[2] ] : undefined );*/
        };

        if (this instanceof THREE.PlaneGeometry) {

            handleParameters(THREE.PlaneGeometry, ['width', 'height', 'widthSegments', 'heightSegments']);

        } else if (this instanceof THREE.BoxGeometry) {

            handleParameters(THREE.BoxGeometry, ['width', 'height', 'depth', 'widthSegments', 'heightSegments', 'depthSegments']);

        } else if (this instanceof THREE.CircleGeometry) {

            handleParameters(THREE.CircleGeometry, ['radius', 'segments']);

        } else if (this instanceof THREE.CylinderGeometry) {

            handleParameters(THREE.CylinderGeometry, ['radiusTop', 'radiusBottom', 'height', 'radialSegments', 'heightSegments', 'openEnded']);

        } else if (this instanceof THREE.SphereGeometry) {

            handleParameters(THREE.SphereGeometry, ['radius', 'widthSegments', 'heightSegments', 'phiStart', 'phiLength', 'thetaStart', 'thetaLength']);

        } else if (this instanceof THREE.IcosahedronGeometry) {

            handleParameters(THREE.IcosahedronGeometry, ['radius', 'detail']);

        } else if (this instanceof THREE.TorusGeometry) {

            handleParameters(THREE.TorusGeometry, ['radius', 'tube', 'radialSegments', 'tubularSegments', 'arc']);

        } else if (this instanceof THREE.TorusKnotGeometry) {

            handleParameters(THREE.TorusKnotGeometry, ['radius', 'tube', 'radialSegments', 'tubularSegments', 'p', 'q', 'heightScale']);

        } else {

            var vertices = this.vertices;

            for (var i = 0, il = vertices.length; i < il; i++) {

                geometry.vertices.push(vertices[i].clone());

            }

            var faces = this.faces;

            for (var i = 0, il = faces.length; i < il; i++) {

                geometry.faces.push(faces[i].clone());

            }

            var uvs = this.faceVertexUvs[0];

            for (var i = 0, il = uvs.length; i < il; i++) {

                var uv = uvs[i], uvCopy = [];

                for (var j = 0, jl = uv.length; j < jl; j++) {

                    uvCopy.push(new THREE.Vector2(uv[j].x, uv[j].y));

                }

                geometry.faceVertexUvs[0].push(uvCopy);

            }

        }

        return geometry;

    }
</script>

<script>

    // physijs paths

    Physijs.scripts.worker = 'js/libs/physijs_worker.js';
    Physijs.scripts.ammo = 'ammo.js';

    //

    window.URL = window.URL || window.webkitURL;
    window.BlobBuilder = window.BlobBuilder || window.WebKitBlobBuilder || window.MozBlobBuilder;

    var workMode = 'easy';

    var editor = new Editor();

    var viewport = new Viewport(editor).setId('viewport');
    document.body.appendChild(viewport.dom);

    /*var menubar = new Menubar( editor ).setId( 'menubar' );
     document.body.appendChild( menubar.dom );*/

    var sidebars = new Sidebars(editor).setId('sidebars');
    document.body.appendChild(sidebars.dom);

    var tools = new Tools(editor).setId('tools');
    document.body.appendChild(tools.dom);

    var gallery = new GalleryPanel(editor).setId('gallery');
    document.body.appendChild(gallery.dom);

    var galleryCamera = new GalleryCameraPanel(editor).setId('galleryCamera');
    document.body.appendChild(galleryCamera.dom);

    var galleryUpload = new GalleryUploadPanel(editor).setId('galleryUpload');
    document.body.appendChild(galleryUpload.dom);
    $(window).load(function () {
        grecaptcha.render(
                $('.g-recaptcha')[0],
                {
                    'sitekey': '6Ld5j_8SAAAAADdyhgzdoSKe6LRR8c75rW5F9RWr',
                    'data-theme': 'dark',
                });
    });


    //

    editor.storage.init(function () {

        editor.storage.get(function (state) {

            if (state !== undefined) {

                /*var loader = new THREE.ObjectLoader();
                 var scene = loader.parse( state.sceneobjects );

                 editor.setScene( scene );*/
                state.type = 'application/zip';

                // before load select theme, as it may alter the (default/loaded) scene and objects
                editor.setTheme(editor.config.getKey('theme'));

                if (!editor.theme.isLoading) {

                    editor.loader.loadFile(state);

                } else {

                    editor.signals.themeLoaded.addOnce(function () {
                        editor.loader.loadFile(this);
                    }.bind(state));

                }

            } else {

                //default scene

                var color = 0xffffff;
                var intensity = 1.0;

                var light = new THREE.DirectionalLight(color, intensity);
                light.name = 'DirectionalLight default';
                light.target.name = 'DirectionalLight default Target';
                light.shadowCameraNear = 0.5;
                light.shadowCameraFar = 30;
                light.shadowCameraLeft = -5;
                light.shadowCameraRight = 5;
                light.shadowCameraTop = 5;
                light.shadowCameraBottom = -3;
                light.castShadow = true;
                //dl.shadowCameraVisible = true;

                //editor.scene.traverse( function(el) { if (el._physijs) { el.castShadow = true; el.receiveShadow = true; } });

                light.position.set(2, 9, 2.5);

                editor.addObject(light);


                editor.scene.fog = new THREE.Fog(0xAAAAAA, 0.01, 50);
                editor.scene.hasLeapBox = true;
                editor.scene._gravity = new THREE.Vector3(0, -16, 0);
                editor.scene.setGravity(editor.scene._gravity);
                editor.scene.maxVelocity = Infinity;


                var color = 0x222222;

                var light = new THREE.AmbientLight(color);
                light.name = 'AmbientLight default';

                editor.addObject(light);


                var width = 100;
                var height = 0.1;
                var depth = 100;

                var widthSegments = 1;
                var heightSegments = 1;
                var depthSegments = 1;

                var geometry = new THREE.BoxGeometry(width, height, depth, widthSegments, heightSegments, depthSegments);
                var material = Physijs.createMaterial(
                        new THREE.MeshPhongMaterial({color: 0x555555}),
                        0.8,
                        1
                );
                var mesh = new Physijs.BoxMesh(geometry, material);
                mesh.name = 'Ground';
                mesh.position.set(0, -0.1, 0);
                mesh.receiveShadow = true;
                mesh.isStatic = true;

                editor.addObject(mesh);

                editor.setTheme(editor.config.getKey('theme'));

            }

            var selected = editor.config.getKey('selected');

            if (selected !== undefined) {

                editor.selectByUuid(selected);

            }

        });

        //load remote scene
        var sceneId = /^\?load_scene=(\d+)/i.exec(window.location.search);
        if (sceneId !== null) {
            editor.loader.loadRemotePlayful(sceneId[0]);
        }

        var timeout;
        var exporter = new THREE.PlayfulExporter();

        var saveState = function (scene) {

            clearTimeout(timeout);

            timeout = setTimeout(function () {

                if (!viewport.play) {
                    //editor.storage.set( { sceneobjects: exporter.parse( editor.scene ), sounds: exporter.sounds } );
                    editor.storage.createZip(function (blob) {

                        blob.name = 'playful.playful';
                        //blob.type = "application/octet-stream";

                        editor.storage.store(blob);

                        /* new File( blob, 'playful.playful', {
                         type: "application/octet-stream" // optional - default = ''
                         } ) );*/

                    });

                }


            }, 1000);

        };

        var signals = editor.signals;

        signals.templateAdded.add(saveState);
        signals.templateDeleted.add(saveState);
        signals.objectAdded.add(saveState);
        signals.objectChanged.add(saveState);
        signals.objectRemoved.add(saveState);
        signals.materialChanged.add(saveState);
        signals.sceneGraphChanged.add(saveState);

    });

    //

    document.addEventListener('dragover', function (event) {

        event.preventDefault();
        event.dataTransfer.dropEffect = 'copy';

    }, false);

    document.addEventListener('drop', function (event) {

        event.preventDefault();
        editor.loader.loadFile(event.dataTransfer.files[0]);

    }, false);

    document.addEventListener('keydown', function (event) {

        switch (event.keyCode) {

            case 8: // prevent browser back
                event.preventDefault();
                break;
            case 46: // delete
                var parent = editor.selected.parent;
                editor.removeObject(editor.selected);
                editor.select(parent);
                break;

        }

    }, false);

    var onWindowResize = function (event) {

        editor.signals.windowResize.dispatch();

    };

    window.addEventListener('resize', onWindowResize, false);

    onWindowResize();

    //

    window.fireCustomEvent = function (element, eventName, data) {

        /*var event;

         if (document.createEvent) {
         event = document.createEvent("HTMLEvents");
         event.initEvent(eventName, true, true);
         } else {
         event = document.createEventObject();
         event.eventType = eventName;
         }

         event.eventName = eventName;

         if (document.createEvent) {
         element.dispatchEvent(event);
         } else {
         element.fireEvent("on" + event.eventType, event);
         }*/

        // Create the event
        var event = new CustomEvent(eventName);

        // Dispatch/Trigger/Fire the event
        element.dispatchEvent(event);

    };

    //CustomEvent polyfill
    (function () {
        function CustomEvent(event, params) {
            params = params || {bubbles: false, cancelable: false, detail: undefined};
            var evt = document.createEvent('CustomEvent');
            evt.initCustomEvent(event, params.bubbles, params.cancelable, params.detail);
            return evt;
        };

        CustomEvent.prototype = window.Event.prototype;

        window.CustomEvent = CustomEvent;
    })();

</script>
</body>
</html>
